---
title: "Production Forecasts"
output: html_document
---
```{r setup, echo = FALSE}
# Set working directory
knitr::opts_knit$set(root.dir = "/home/esa/production_forecasts") # Working on Ubuntu
```

```{r imports, message = FALSE, echo = FALSE}
library(forecast)
library(ggplot2)
library(gridExtra)
library(knitr)
library(readxl)
library(plyr)
library(lubridate)
library(numbers)
library(data.table)
library(R.utils)
library(ggrepel)
source("src/evalhelp.R")
```

```{r read_files, include = FALSE}
###                                                                                 ###
# IT IS NOT YET KNOWN WHAT THE FINAL PATH WILL BE AND IF THE FILES COME TO US CLEANED #
###                                                                                 ###  

# Get all the files
PATH <- "/home/esa/production_forecasts/data/FACS/"
files <- list.files(path = PATH, pattern = "FAC0091_*")  # Character vector of file names

# Compile a dataframe by going over all files
dlist <- list()
for (i in files) {
  # Read a single file to a df called d
  d <- read.delim(file = paste0(PATH, "/", i), header = FALSE, sep = ";", stringsAsFactors = FALSE, colClasses = 'character')
  
  if(length(d) == 26){
    d <- d[, !(names(d) %in% c("V10"))]  # The column numbers unfortunately vary between files, so we'll adjust
    }
  
  colnames(d) <- c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10",
                   "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20",
                   "V21", "V22", "V23", "V24", "V25")  # This is done so as to have easier column handling later on
  dlist[[i]] <- d
}

d <- as.data.frame(rbindlist(dlist, fill = TRUE))
```

```{r modify_dataframe, include = FALSE}
# Divide into distributions (P) and returns (R)
P <- d[d$V1 == "P", ]
R <- d[d$V1 == "R", ]

# For distributions, we'll keep Distribution date, Quantity, ABO type, Volume, Exp date
keep <- c("V12", "V14", "V18", "V20", "V22", "V24")
distr <- P[keep]
colnames(distr) <- c("date", "product", "quantity", "ABO", "volume", "exp")

# For returns we keep the return date and quantity
keep <- c("V4", "V7")
retrn <- R[keep]
colnames(retrn) <- c("date", "quantity")

# Datify
distr$date <- dmy(distr$date); distr$exp <- dmy(distr$exp)
retrn$date <- dmy(retrn$date)

# Numerify
distr$quantity <- as.numeric(distr$quantity); distr$volume <- as.numeric(distr$volume)
retrn$quantity <- as.numeric(retrn$quantity)

# Product codes for red cell products
red.codes <- c("budTR001", "A0071V00", "A0074V00", "A0092VA0", "A0092VB0", 
               "E3844V00", "E3845V00", "E3846VA0", "E3846VB0", "E3846VC0",
               "E3846V00", "E3847VA0", "E3847VB0", "E3847VC0", "E3847V00",
               "E3936VA0", "E3936VB0", "E3939V00", "E3940V00", "E4683V00",
               "E7668V00", "E7673V00", "E4999V00", "E5000V00")

red.distr <- distr[distr$product %in% red.codes, ]

# Product codes for platelets
plat.codes <- c("budTR002", "trEnnApu", "A0004V00", "A0005V00", "A0006V00", "A0007V00", "A0008V00",
                "A0086VA0", "A0086VB0", "A0086V00", "A0088V00", "A0088VA0", "A0088VB0", "A0089V00",
                "A0089VB0", "A0089VA0", "A0090V00", "A0090VA0", "A0090VB0", "A0018V00", "A0020V00", 
                "A0021V00", "A0021VA0", "A0021VB0", "A0047V00", "A0049V00", "A0051V00", "A0054V00",
                "A0055V00", "A0056V00", "A0057V00", "A0059V00", "A0060V00", "A0067VA0", "A0067VB0",
                "A0067V00", "A0068VA0", "A0068VB0", "A0068V00", "A0075V00", "A0101V00", "A0102V00",
                "E3949V00", "E3953V00", "E3954V00", "E3955V00", "E3956V00", "E3957V00", "E3958V00",
                "E3959V00", "E3960V00", "E3961V00", "E3962V00", "E3963V00", "E3964V00", "E3965V00", 
                "E3966V00", "E3968VA0", "E3968VB0", "E3968V00", "E3970V00", "E3971V00", "E3973V00",
                "E3974V00", "E3976V00", "E3981V00", "E3995V00", "E3996V00", "E3997V00", "E3997VA0",
                "E3997VB0", "E4002V00", "E4004V00", "E6782V00", "E6783V00", "E6953V00", "E6860V00",
                "E6874VA0", "E6874V00", "E6874VB0", "E6875VB0", "E6875V00", "E7530V00", "E7530VA0",
                "E7530VB0", "E7531V00", "E7531VA0", "E7531VB0", "E6875VA0")

plat.distr <- distr[distr$product %in% plat.codes, ]
```

```{r create_datasets, include = FALSE}
# Create a full sequence of dates for imputation purposes
all.dates <- (seq.Date(min(red.distr$date),
                       max(red.distr$date),
                       "day"))
###           ###
#   RED CELLS   #
###           ###
all.red <- aggregate(red.distr$quantity, by = list(red.distr$date), sum); colnames(all.red) <- c("date", "pcs")
# Merge into a whole set with NAs
all.red <- merge(x = data.frame(date = all.dates),
                 y = all.red,
                 all.x = TRUE)
# Replace with zeroes
all.red[is.na(all.red)] <- 0
# Cut to time after 2014
all.red <- all.red[all.red$date >= as.Date("2014-01-06"), ]


# O minus
Ominus <- red.distr[red.distr$ABO == "O -", ]
Ominus.distr <- aggregate(Ominus$quantity, by = list(Ominus$date), sum); colnames(Ominus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Ominus.distr <- merge(x = data.frame(date = all.dates),
                      y = Ominus.distr,
                      all.x = TRUE)
# Replace with zeroes
Ominus.distr[is.na(Ominus.distr)] <- 0
# Cut to time after 2014
Ominus.distr <- Ominus.distr[Ominus.distr$date >= as.Date("2014-01-06"), ]

# O plus
Oplus <- red.distr[red.distr$ABO == "O +", ]
Oplus.distr <- aggregate(Oplus$quantity, by = list(Oplus$date), sum); colnames(Oplus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Oplus.distr <- merge(x = data.frame(date = all.dates),
                     y = Oplus.distr,
                     all.x = TRUE)
# Replace with zeroes
Oplus.distr[is.na(Oplus.distr)] <- 0
# Cut to time after 2014
Oplus.distr <- Oplus.distr[Oplus.distr$date >= as.Date("2014-01-06"), ]

# A minus
Aminus <- red.distr[red.distr$ABO == "A -", ]
Aminus.distr <- aggregate(Aminus$quantity, by = list(Aminus$date), sum); colnames(Aminus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Aminus.distr <- merge(x = data.frame(date = all.dates),
                      y = Aminus.distr,
                      all.x = TRUE)
# Replace with zeroes
Aminus.distr[is.na(Aminus.distr)] <- 0
# Cut to time after 2014
Aminus.distr <- Aminus.distr[Aminus.distr$date >= as.Date("2014-01-06"), ]

# A plus
Aplus <- red.distr[red.distr$ABO == "A +", ]
Aplus.distr <- aggregate(Aplus$quantity, by = list(Aplus$date), sum); colnames(Aplus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Aplus.distr <- merge(x = data.frame(date = all.dates),
                     y = Aplus.distr,
                     all.x = TRUE)
# Replace with zeroes
Aplus.distr[is.na(Aplus.distr)] <- 0
# Cut to time after 2014
Aplus.distr <- Aplus.distr[Aplus.distr$date >= as.Date("2014-01-06"), ]

# B minus
Bminus <- red.distr[red.distr$ABO == "B -", ]
Bminus.distr <- aggregate(Bminus$quantity, by = list(Bminus$date), sum); colnames(Bminus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Bminus.distr <- merge(x = data.frame(date = all.dates),
                      y = Bminus.distr,
                      all.x = TRUE)
# Replace with zeroes
Bminus.distr[is.na(Bminus.distr)] <- 0
# Cut to time after 2014
Bminus.distr <- Bminus.distr[Bminus.distr$date >= as.Date("2014-01-06"), ]

# B plus
Bplus <- red.distr[red.distr$ABO == "B +", ]
Bplus.distr <- aggregate(Bplus$quantity, by = list(Bplus$date), sum); colnames(Bplus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
Bplus.distr <- merge(x = data.frame(date = all.dates),
                     y = Bplus.distr,
                     all.x = TRUE)
# Replace with zeroes
Bplus.distr[is.na(Bplus.distr)] <- 0
# Cut to time after 2014
Bplus.distr <- Bplus.distr[Bplus.distr$date >= as.Date("2014-01-06"), ]

# AB minus
ABminus <- red.distr[red.distr$ABO == "AB-", ]
ABminus.distr <- aggregate(ABminus$quantity, by = list(ABminus$date), sum); colnames(ABminus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
ABminus.distr <- merge(x = data.frame(date = all.dates),
                       y = ABminus.distr,
                       all.x = TRUE)
# Replace with zeroes
ABminus.distr[is.na(ABminus.distr)] <- 0
# Cut to time after 2014
ABminus.distr <- ABminus.distr[ABminus.distr$date >= as.Date("2014-01-06"), ]

# AB plus
ABplus <- red.distr[red.distr$ABO == "AB+", ]
ABplus.distr <- aggregate(ABplus$quantity, by = list(ABplus$date), sum); colnames(ABplus.distr) <- c("date", "pcs")
# Merge into a whole set with NAs
ABplus.distr <- merge(x = data.frame(date = all.dates),
                      y = ABplus.distr,
                      all.x = TRUE)
# Replace with zeroes
ABplus.distr[is.na(ABplus.distr)] <- 0
# Cut to time after 2014
ABplus.distr <- ABplus.distr[ABplus.distr$date >= as.Date("2014-01-06"), ]


###           ###
#   PLATELETS   #
###           ###
all.plat <- aggregate(plat.distr$quantity, by = list(plat.distr$date), sum); colnames(all.plat) <- c("date", "pcs")
# Merge into a whole set with NAs
all.plat <- merge(x = data.frame(date = all.dates),
                  y = all.plat,
                  all.x = TRUE)
# Replace with zeroes
all.plat[is.na(all.plat)] <- 0
# Cut to time after 2014
all.plat <- all.plat[all.plat$date >= as.Date("2014-01-06"), ]
```

```{r datasets_monthly, include = FALSE, warning = FALSE}
# Aggregate all by months
red.monthly <- aggregate(pcs ~ month(date) + year(date), data = all.red, FUN = sum)
Ominus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Ominus.distr, FUN = sum)
Oplus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Oplus.distr, FUN = sum)
Aminus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Aminus.distr, FUN = sum)
Aplus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Aplus.distr, FUN = sum)
Bminus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Bminus.distr, FUN = sum)
Bplus.monthly <- aggregate(pcs ~ month(date) + year(date), data = Bplus.distr, FUN = sum)
ABminus.monthly <- aggregate(pcs ~ month(date) + year(date), data = ABminus.distr, FUN = sum)
ABplus.monthly <- aggregate(pcs ~ month(date) + year(date), data = ABplus.distr, FUN = sum)
plat.monthly <- aggregate(pcs ~ month(date) + year(date), data = all.plat, FUN = sum)

# Dates
months <- seq(from = as.Date("2014-01-06"), to = max(distr$date), by = "month")

# Adjustment series
adj <- as.numeric(bizdays(ts(months, start = decimal_date(as.Date("2014-01-06")), frequency = 12), FinCenter = "Zurich"))
reverse_adj <- as.numeric(bizdays(ts(seq(6), start = decimal_date(as.Date(tail(months, 1))), frequency = 12), FinCenter = "Zurich"))

# Create a master frame
monthly <- data.frame(date = months,
                      red = red.monthly$pcs/adj,
                      Ominus = Ominus.monthly$pcs/adj,
                      Oplus = Oplus.monthly$pcs/adj,
                      Aminus = Aminus.monthly$pcs/adj,
                      Aplus = Aplus.monthly$pcs/adj,
                      Bminus = Bminus.monthly$pcs/adj,
                      Bplus = Bplus.monthly$pcs/adj,
                      ABminus = ABminus.monthly$pcs/adj,
                      ABplus = ABplus.monthly$pcs/adj,
                      plat = plat.monthly$pcs/adj)

monthly_real <- data.frame(date = months,
                           red = red.monthly$pcs,
                           Ominus = Ominus.monthly$pcs,
                           Oplus = Oplus.monthly$pcs,
                           Aminus = Aminus.monthly$pcs,
                           Aplus = Aplus.monthly$pcs,
                           Bminus = Bminus.monthly$pcs,
                           Bplus = Bplus.monthly$pcs,
                           ABminus = ABminus.monthly$pcs,
                           ABplus = ABplus.monthly$pcs,
                           plat = plat.monthly$pcs)
```

```{r datasets_weekly, include = FALSE}
# Weekly aggregation is a bit more tricky operation as weekly aggregate gives incorrect results

# ALL.RED
pcslist <- list(); weeklist <- list(); datelist <- list()  # Create storage lists
j <- 0; k <- 0  # j is for resetting week counter, k is for gathering dates
for(i in seq(to = length(all.red$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(all.red$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- all.red$date[i]
}
red.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# OMINUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Ominus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Ominus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Ominus.distr$date[i]
}
Ominus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# OPLUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Oplus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Oplus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Oplus.distr$date[i]
}
Oplus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# AMINUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Aminus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Aminus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Aminus.distr$date[i]
}
Aminus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# APLUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Aplus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Aplus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Aplus.distr$date[i]
}
Aplus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# BMINUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Bminus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Bminus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Bminus.distr$date[i]
}
Bminus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# BPLUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(Bplus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(Bplus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- Bplus.distr$date[i]
}
Bplus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# ABMINUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(ABminus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(ABminus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- ABminus.distr$date[i]
}
ABminus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# ABPLUS
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(ABplus.distr$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(ABplus.distr$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- ABplus.distr$date[i]
}
ABplus.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# ALL.PLAT
pcslist <- list(); weeklist <- list(); datelist <- list()
j <- 0; k <- 0
for(i in seq(to = length(all.plat$date), by = 7)){
  if(j == 52){j <- 0}
  j <- j + 1
  k <- k + 1
  pcslist[[k]] <- sum(all.plat$pcs[i : (i + 6)])
  weeklist[[k]] <- j
  datelist[[k]] <- all.plat$date[i]
}
plat.weekly <- data.frame(week = unlist(weeklist), startdate = as.Date.numeric(unlist(datelist), origin = "1970-01-01"), pcs = unlist(pcslist))

# Create a master frame
weekly <- data.frame(week = red.weekly$week,
                     startdate = red.weekly$startdate,
                     red = red.weekly$pcs,
                     Ominus = Ominus.weekly$pcs,
                     Oplus = Oplus.weekly$pcs,
                     Aminus = Aminus.weekly$pcs,
                     Aplus = Aplus.weekly$pcs,
                     Bminus = Bminus.weekly$pcs,
                     Bplus = Bplus.weekly$pcs,
                     ABminus = ABminus.weekly$pcs,
                     ABplus = ABplus.weekly$pcs,
                     plat = plat.weekly$pcs)
```

## 6 month forecast {.tabset .tabset-fade .tabset-pills}

### All red
```{r monthly_historical_errors_red, message = FALSE, warning = FALSE, echo = FALSE, results = FALSE}
# Define the series to be used
# We want to use 4 years of data. 3 years for the width of the rolling window and we'll let that run for a year.
segment <- head(tail(monthly$red, 49), 48)
beginning <- head(tail(monthly$date, 49), 1)
series.ts <- ts(segment, start = decimal_date(beginning), frequency = 12)

############################
# ETS
############################
capes <- c()
# Create progress bar
cat("\nRUNNING ETS\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- ets(train)
  
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

ets.capes <- capes

############################
# STL
############################
capes <- c()
# Create progress bar
cat("\nRUNNING STL\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

stl.capes <- capes

############################
# TBATS
############################
capes <- c()
# Create progress bar
cat("\nRUNNING TBATS\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

tbats.capes <- capes

############################
# STLF
############################
capes <- c()
# Create progress bar
cat("\nRUNNING STLF\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

stlf.capes <- capes

############################
# LMx2
############################
capes <- c()
cat("\nRUNNING LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

lmx2.capes <- capes

############################
# NAIVE
############################
capes <- c()
cat("\nRUNNING NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

naive.capes <- capes

############################
# SNAIVE
############################
capes <- c()
cat("\nRUNNING SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

snaive.capes <- capes

############################
# RWF
############################
capes <- c()
cat("\nRUNNING RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

rwf.capes <- capes

############################
# MEANF
############################
capes <- c()
cat("\nRUNNING MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

meanf.capes <- capes

############################
# Smooth .25 ETS
############################
capes <- c()
cat("\nRUNNING SMOOTH ETS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- ets(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthets.capes <- capes

############################
# Smooth .25 STL
############################
capes <- c()
cat("\nRUNNING SMOOTH STL\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthstl.capes <- capes

############################
# Smooth .25 TBATS
############################
capes <- c()
cat("\nRUNNING SMOOTH TBATS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthtbats.capes <- capes

############################
# Smooth .25 STLF
############################
capes <- c()
cat("\nRUNNING SMOOTH STLF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthstlf.capes <- capes

############################
# Smooth .25 LMx2
############################
capes <- c()
cat("\nRUNNING SMOOTH LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthlmx2.capes <- capes

############################
# Smooth .25 NAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthnaive.capes <- capes

############################
# Smooth .25 SNAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthsnaive.capes <- capes

############################
# Smooth .25 RWF
############################
capes <- c()
cat("\nRUNNING SMOOTH RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthrwf.capes <- capes

############################
# Smooth .25 MEANF
############################
capes <- c()
cat("\nRUNNING SMOOTH MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthmeanf.capes <- capes

############################
# Smooth .10 ETS
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 ETS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- ets(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10ets.capes <- capes

############################
# Smooth .10 STL
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 STL\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10stl.capes <- capes

############################
# Smooth .10 TBATS
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 TBATS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10tbats.capes <- capes

############################
# Smooth .10 STLF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 STLF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10stlf.capes <- capes

############################
# Smooth .10 LMx2
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10lmx2.capes <- capes

############################
# Smooth .10 NAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10naive.capes <- capes

############################
# Smooth .10 SNAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10snaive.capes <- capes

############################
# Smooth .10 RWF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10rwf.capes <- capes

############################
# Smooth .10 MEANF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10meanf.capes <- capes

m <- matrix(c(ets.capes, stl.capes, tbats.capes, stlf.capes, lmx2.capes, 
              naive.capes, snaive.capes, rwf.capes, meanf.capes,
              smthets.capes, smthstl.capes, smthtbats.capes, smthstlf.capes, 
              smthlmx2.capes, smthnaive.capes, smthsnaive.capes, smthrwf.capes, smthmeanf.capes,
              smth10ets.capes, smth10stl.capes, smth10tbats.capes, smth10stlf.capes, 
              smth10lmx2.capes, smth10naive.capes, smth10snaive.capes, smth10rwf.capes, smth10meanf.capes),
            ncol = 27,
            byrow = TRUE)

modelnames <- c("ETS", "STL", "TBATS", "STLF", "LMx2", "NAIVE", "SNAIVE", "RWF", "MEANF",
                "ETS.25", "STL.25", "TBATS.25", "STLF.25", "LMx2.25", "NAIVE.25", "SNAIVE.25", "RWF.25", "MEANF.25",
                "ETS.10", "STL.10", "TBATS.10", "STLF.10", "LMx2.10", "NAIVE.10", "SNAIVE.10", "RWF.10", "MEANF.10")
colnames(m) <- modelnames

mdf <- as.data.frame(m)

chosen.model <- which.min(colMeans(mdf))[[1]]

# Actual forecasts if this model chosen
train <- ts(tail(series.ts, 36), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)
train25 <- ts(itsmr::smooth.fft(tail(series.ts, 36), .25), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)
train10 <- ts(itsmr::smooth.fft(tail(series.ts, 36), .10), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)

if(chosen.model == 1){fit <- ets(train)}
if(chosen.model == 2){fit <- stl(train, s.window = "periodic", t.window = 7)}
if(chosen.model == 3){fit <- tbats(train)}
if(chosen.model == 4){fit <- stlf(train)}
if(chosen.model == 5){
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 6){fit <- naive(train)}
if(chosen.model == 7){fit <- snaive(train)}
if(chosen.model == 8){fit <- rwf(train, drift = TRUE)}
if(chosen.model == 9){fit <- meanf(train)}
if(chosen.model == 10){fit <- ets(train25)}
if(chosen.model == 11){fit <- stl(train25, s.window = "periodic", t.window = 7)}
if(chosen.model == 12){fit <- tbats(train25)}
if(chosen.model == 13){fit <- stlf(train25)}
if(chosen.model == 14){
  fit1 <- tslm(train25 ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 15){fit <- naive(train25)}
if(chosen.model == 16){fit <- snaive(train25)}
if(chosen.model == 17){fit <- rwf(train25, drift = TRUE)}
if(chosen.model == 18){fit <- meanf(train25)}
if(chosen.model == 19){fit <- ets(train10)}
if(chosen.model == 20){fit <- stl(train10, s.window = "periodic", t.window = 7)}
if(chosen.model == 21){fit <- tbats(train10)}
if(chosen.model == 22){fit <- stlf(train10)}
if(chosen.model == 23){
  fit1 <- tslm(train10 ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 24){fit <- naive(train10)}
if(chosen.model == 25){fit <- snaive(train10)}
if(chosen.model == 26){fit <- rwf(train10, drift = TRUE)}
if(chosen.model == 27){fit <- meanf(train10)}

fcast <- forecast(fit, h = 6)
forecasts <- as.numeric(fcast$mean) * reverse_adj
upper80s <- as.numeric(fcast$upper[, 1]) * reverse_adj
upper95s <- as.numeric(fcast$upper[, 2]) * reverse_adj
lower80s <- as.numeric(fcast$lower[, 1]) * reverse_adj
lower95s <- as.numeric(fcast$lower[, 2]) * reverse_adj

fdf <- data.frame(fcast = forecasts,
                  upper80 = upper80s,
                  upper95 = upper95s,
                  lower80 = lower80s,
                  lower95 = lower95s)

save.this <- data.frame(time = tail(monthly$date, 1), 
                        model = modelnames[chosen.model], 
                        forecast = fdf$fcast[1],
                        upper80 = fdf$upper80[1],
                        upper95 = fdf$upper95[1],
                        lower80 = fdf$lower80[1],
                        lower95 = fdf$lower95[1])

# Save to file for historical review
write.table(save.this, file = "histories/monthly_red.csv", sep = ",", row.names = FALSE, col.names = FALSE)

```

```{r monthly_red_fig, fig.align="center", echo = FALSE}
ggplot(data = fdf, aes(x = seq.Date(from = tail(monthly_real$date, 1), to = tail(monthly_real$date, 1) + months(5), by = "month"), y = fcast)) + 
  geom_line() + 
  geom_line(data = head(monthly_real, -1), aes(x = date, y = red)) +
  geom_ribbon(data = fdf, aes(ymin = lower80, ymax = upper80), alpha = 0.3) +
  geom_ribbon(data = fdf, aes(ymin = lower95, ymax = upper95), alpha = 0.2, fill = "blue") +
  geom_segment(x = tail(monthly_real$date, 2)[1], y = tail(monthly_real$red, 2)[1], xend = tail(monthly_real$date, 1), yend = head(fdf$fcast, 1), color = "black", linetype = "dashed") +
  labs(title = "All red cell products",
       subtitle = paste0("Best performing model of the previous year: ", modelnames[chosen.model]),
       x = "Time",
       y = "Units per month") +
  theme_minimal()
```

<style>
div.summary { background-color:#e6f0ff; border-radius: 5px; padding: 20px; font-size: 25px;}
</style>
<div class = "summary">

Next month: `r format(round(head(fdf$fcast, 1), 0))  # This is to round AND display only whole numbers.`

</div>

### By type
```{r monthly_historical_errors_Ominus, message = FALSE, warning = FALSE, echo = FALSE, results = FALSE}
# Define the series to be used
# We want to use 4 years of data. 3 years for the width of the rolling window and we'll let that run for a year.
segment <- head(tail(monthly$Ominus, 49), 48)
beginning <- head(tail(monthly$date, 49), 1)
series.ts <- ts(segment, start = decimal_date(beginning), frequency = 12)

############################
# ETS
############################
capes <- c()
# Create progress bar
cat("\nRUNNING ETS\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- ets(train)
  
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

ets.capes <- capes

############################
# STL
############################
capes <- c()
# Create progress bar
cat("\nRUNNING STL\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

stl.capes <- capes

############################
# TBATS
############################
capes <- c()
# Create progress bar
cat("\nRUNNING TBATS\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

tbats.capes <- capes

############################
# STLF
############################
capes <- c()
# Create progress bar
cat("\nRUNNING STLF\n")
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

stlf.capes <- capes

############################
# LMx2
############################
capes <- c()
cat("\nRUNNING LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

lmx2.capes <- capes

############################
# NAIVE
############################
capes <- c()
cat("\nRUNNING NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

naive.capes <- capes

############################
# SNAIVE
############################
capes <- c()
cat("\nRUNNING SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

snaive.capes <- capes

############################
# RWF
############################
capes <- c()
cat("\nRUNNING RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

rwf.capes <- capes

############################
# MEANF
############################
capes <- c()
cat("\nRUNNING MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(series.ts[(1 + i):(36 + i)], start = decimal_date(beginning + i), frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

meanf.capes <- capes

############################
# Smooth .25 ETS
############################
capes <- c()
cat("\nRUNNING SMOOTH ETS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- ets(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthets.capes <- capes

############################
# Smooth .25 STL
############################
capes <- c()
cat("\nRUNNING SMOOTH STL\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthstl.capes <- capes

############################
# Smooth .25 TBATS
############################
capes <- c()
cat("\nRUNNING SMOOTH TBATS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthtbats.capes <- capes

############################
# Smooth .25 STLF
############################
capes <- c()
cat("\nRUNNING SMOOTH STLF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthstlf.capes <- capes

############################
# Smooth .25 LMx2
############################
capes <- c()
cat("\nRUNNING SMOOTH LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthlmx2.capes <- capes

############################
# Smooth .25 NAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthnaive.capes <- capes

############################
# Smooth .25 SNAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthsnaive.capes <- capes

############################
# Smooth .25 RWF
############################
capes <- c()
cat("\nRUNNING SMOOTH RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthrwf.capes <- capes

############################
# Smooth .25 MEANF
############################
capes <- c()
cat("\nRUNNING SMOOTH MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .25), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smthmeanf.capes <- capes

############################
# Smooth .10 ETS
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 ETS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- ets(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10ets.capes <- capes

############################
# Smooth .10 STL
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 STL\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stl(train, s.window = "periodic", t.window = 7)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10stl.capes <- capes

############################
# Smooth .10 TBATS
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 TBATS\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- tbats(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10tbats.capes <- capes

############################
# Smooth .10 STLF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 STLF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- stlf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10stlf.capes <- capes

############################
# Smooth .10 LMx2
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 LMx2\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit & Forecast
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 1)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 1)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10lmx2.capes <- capes

############################
# Smooth .10 NAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 NAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)
  
  # Fit
  fit <- naive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10naive.capes <- capes

############################
# Smooth .10 SNAIVE
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 SNAIVE\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- snaive(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10snaive.capes <- capes

############################
# Smooth .10 RWF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 RWF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- rwf(train, drift = TRUE)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10rwf.capes <- capes

############################
# Smooth .10 MEANF
############################
capes <- c()
cat("\nRUNNING SMOOTH .10 MEANF\n")
# Create progress bar
pb <- txtProgressBar(min = 1, max = length(series.ts) - 37, style = 3)
for(i in seq(length(series.ts) - 37)){
  # Define training and testing set as ROLLING WINDOW
  train <- ts(itsmr::smooth.fft(series.ts[(1 + i):(36 + i)], .10), 
              start = decimal_date(beginning), 
              frequency = 12)
  test <- ts(series.ts[(37 + i)], start = decimal_date(beginning + 37 + i), frequency = 12)

  # Fit
  fit <- meanf(train)
  # Forecast 1 step (week) ahead
  fcast <- forecast(fit, h = 1)
  
  # Calculate errors
  e <- as.numeric(test) - as.numeric(fcast$mean)  # Raw error
  cape <- ifelse(test = e > 0, yes = abs(e * 2), no = abs(e))/test * 100  # Critical APE (for cMAPE later on)
  
  # Save errors
  capes <- c(capes, cape)
  
  setTxtProgressBar(pb, i) # Update progress bar
}
close(pb) # Close progress bar

smth10meanf.capes <- capes

m <- matrix(c(ets.capes, stl.capes, tbats.capes, stlf.capes, lmx2.capes, 
              naive.capes, snaive.capes, rwf.capes, meanf.capes,
              smthets.capes, smthstl.capes, smthtbats.capes, smthstlf.capes, 
              smthlmx2.capes, smthnaive.capes, smthsnaive.capes, smthrwf.capes, smthmeanf.capes,
              smth10ets.capes, smth10stl.capes, smth10tbats.capes, smth10stlf.capes, 
              smth10lmx2.capes, smth10naive.capes, smth10snaive.capes, smth10rwf.capes, smth10meanf.capes),
            ncol = 27,
            byrow = TRUE)

modelnames <- c("ETS", "STL", "TBATS", "STLF", "LMx2", "NAIVE", "SNAIVE", "RWF", "MEANF",
                "ETS.25", "STL.25", "TBATS.25", "STLF.25", "LMx2.25", "NAIVE.25", "SNAIVE.25", "RWF.25", "MEANF.25",
                "ETS.10", "STL.10", "TBATS.10", "STLF.10", "LMx2.10", "NAIVE.10", "SNAIVE.10", "RWF.10", "MEANF.10")
colnames(m) <- modelnames

mdf <- as.data.frame(m)

chosen.model <- which.min(colMeans(mdf))[[1]]

# Actual forecasts if this model chosen
train <- ts(tail(series.ts, 36), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)
train25 <- ts(itsmr::smooth.fft(tail(series.ts, 36), .25), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)
train10 <- ts(itsmr::smooth.fft(tail(series.ts, 36), .10), start = decimal_date(head(tail(monthly$date, 36), 1)), frequency = 12)

if(chosen.model == 1){fit <- ets(train)}
if(chosen.model == 2){fit <- stl(train, s.window = "periodic", t.window = 7)}
if(chosen.model == 3){fit <- tbats(train)}
if(chosen.model == 4){fit <- stlf(train)}
if(chosen.model == 5){
  fit1 <- tslm(train ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 6){fit <- naive(train)}
if(chosen.model == 7){fit <- snaive(train)}
if(chosen.model == 8){fit <- rwf(train, drift = TRUE)}
if(chosen.model == 9){fit <- meanf(train)}
if(chosen.model == 10){fit <- ets(train25)}
if(chosen.model == 11){fit <- stl(train25, s.window = "periodic", t.window = 7)}
if(chosen.model == 12){fit <- tbats(train25)}
if(chosen.model == 13){fit <- stlf(train25)}
if(chosen.model == 14){
  fit1 <- tslm(train25 ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 15){fit <- naive(train25)}
if(chosen.model == 16){fit <- snaive(train25)}
if(chosen.model == 17){fit <- rwf(train25, drift = TRUE)}
if(chosen.model == 18){fit <- meanf(train25)}
if(chosen.model == 19){fit <- ets(train10)}
if(chosen.model == 20){fit <- stl(train10, s.window = "periodic", t.window = 7)}
if(chosen.model == 21){fit <- tbats(train10)}
if(chosen.model == 22){fit <- stlf(train10)}
if(chosen.model == 23){
  fit1 <- tslm(train10 ~ trend + season)
  fcast1 <- forecast(fit1, h = 6)
 
  fit2 <- auto.arima(fit1$residuals)
  fcast2 <- forecast(fit2, h = 6)
  
  y <- as.numeric(fcast1$mean)
  x <- as.numeric(fcast2$mean)
  fcast <- x + y
  upper80s <- fcast1$upper[[1]]
  upper95s <- fcast1$upper[[2]]
  lower80s <- fcast1$lower[[1]]
  lower95s <- fcast1$lower[[2]]
  }
if(chosen.model == 24){fit <- naive(train10)}
if(chosen.model == 25){fit <- snaive(train10)}
if(chosen.model == 26){fit <- rwf(train10, drift = TRUE)}
if(chosen.model == 27){fit <- meanf(train10)}

fcast <- forecast(fit, h = 6)
forecasts <- as.numeric(fcast$mean) * reverse_adj
upper80s <- as.numeric(fcast$upper[, 1]) * reverse_adj
upper95s <- as.numeric(fcast$upper[, 2]) * reverse_adj
lower80s <- as.numeric(fcast$lower[, 1]) * reverse_adj
lower95s <- as.numeric(fcast$lower[, 2]) * reverse_adj

fdf <- data.frame(fcast = forecasts,
                  upper80 = upper80s,
                  upper95 = upper95s,
                  lower80 = lower80s,
                  lower95 = lower95s)

```

```{r monthly_Ominus_fig, fig.align="center", echo = FALSE}
ggplot(data = fdf, aes(x = seq.Date(from = tail(monthly_real$date, 1), to = tail(monthly_real$date, 1) + months(5), by = "month"), y = fcast)) + 
  geom_line() + 
  geom_line(data = head(monthly_real, -1), aes(x = date, y = Ominus)) +
  geom_ribbon(data = fdf, aes(ymin = lower80, ymax = upper80), alpha = 0.3) +
  geom_ribbon(data = fdf, aes(ymin = lower95, ymax = upper95), alpha = 0.2, fill = "blue") +
  geom_segment(x = tail(monthly_real$date, 2)[1], y = tail(monthly_real$Ominus, 2)[1], xend = tail(monthly_real$date, 1), yend = head(fdf$fcast, 1), color = "black", linetype = "dashed") +
  labs(title = "O-",
       subtitle = paste0("Best performing model of the previous year: ", modelnames[chosen.model]),
       x = "Time",
       y = "Units per day") +
  theme_minimal()
```

<style>
div.summary { background-color:#e6f0ff; border-radius: 5px; padding: 20px; font-size: 25px;}
</style>
<div class = "summary">

Next month: `r format(round(head(fdf$fcast, 1), 0))  # This is to round AND display only whole numbers.`

</div>

### Platelets







## Model history {.tabset .tabset-fade .tabset-pills}

### All red
```{r red_history, echo = FALSE}
# Load history
history <- read.csv("histories/monthly_red.csv", header = TRUE)

ggplot(data = history, aes(x = as.Date(time), y = forecast), label = model) +
  geom_line(color = "red") +
  geom_line(data = head(monthly_real, -1), aes(x = date, y = red)) +
  theme_minimal() +
  labs(title = "Entire forecast history",
       subtitle = paste0("Mean error: ", 
                         round(100*abs(mean((head(tail(monthly_real$red, 19), 18) - history$forecast) / head(tail(monthly_real$red, 19), 18))), 2), 
                         "%"),
       x = "Time",
       y = "Units per month") +
  annotate(geom = "text", x = as.Date(history$time), y = 14300, label = history$model, size = 2.5, angle = 90)
  

```

### By blood type
```{r, echo = FALSE}
year.segment <- monthly[(length(monthly$Ominus)-12):(length(monthly$Ominus)-1), ]

ggplot(data = head(monthly, -1), aes(x = date, y = Ominus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Ominus), method = "lm", inherit.aes = FALSE) +
  labs(title = "O-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Ominus ~ seq_along(year.segment$Ominus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = Oplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Oplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "O+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Oplus ~ seq_along(year.segment$Oplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = Aminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Aminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "A-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Aminus ~ seq_along(year.segment$Aminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = Aplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Aplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "A+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Aplus ~ seq_along(year.segment$Aplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = Bminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Bminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "B-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Bminus ~ seq_along(year.segment$Bminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = Bplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = Bplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "B+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Bplus ~ seq_along(year.segment$Bplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = ABminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = ABminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "AB-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$ABminus ~ seq_along(year.segment$ABminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(monthly, -1), aes(x = date, y = ABplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = ABplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "AB+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$ABplus ~ seq_along(year.segment$ABplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")
```

### Platelets
```{r, echo = FALSE}
year.segment <- monthly[(length(monthly$plat)-12):(length(monthly$plat)-1), ]
ggplot(data = head(monthly, -1), aes(x = date, y = plat)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = date, y = plat), method = "lm", inherit.aes = FALSE) +
  labs(title = "All platelet products",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$plat ~ seq_along(year.segment$plat))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")
```

## Historical weekly demand {.tabset .tabset-fade .tabset-pills}

### All red
```{r, echo = FALSE}
year.segment <- weekly[(length(weekly$red)-52):(length(weekly$red)-1), ]
ggplot(data = head(weekly, -1), aes(x = startdate, y = red)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = red), method = "lm", inherit.aes = FALSE) +
  labs(title = "All red cell products",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$red ~ seq_along(year.segment$red))$coefficients[2] >= 0, 
                                                              yes = "upward.", 
                                                              no = "downward.")),
       x = "Date",
       y = "Blood bags")
```

### By blood type
```{r, echo = FALSE}
ggplot(data = head(weekly, -1), aes(x = startdate, y = Ominus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Ominus), method = "lm", inherit.aes = FALSE) +
  labs(title = "O-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Ominus ~ seq_along(year.segment$Ominus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = Oplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Oplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "O+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Oplus ~ seq_along(year.segment$Oplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = Aminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Aminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "A-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Aminus ~ seq_along(year.segment$Aminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = Aplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Aplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "A+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Aplus ~ seq_along(year.segment$Aplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = Bminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Bminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "B-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Bminus ~ seq_along(year.segment$Bminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = Bplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = Bplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "B+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$Bplus ~ seq_along(year.segment$Bplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = ABminus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = ABminus), method = "lm", inherit.aes = FALSE) +
  labs(title = "AB-",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$ABminus ~ seq_along(year.segment$ABminus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")

ggplot(data = head(weekly, -1), aes(x = startdate, y = ABplus)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = ABplus), method = "lm", inherit.aes = FALSE) +
  labs(title = "AB+",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$ABplus ~ seq_along(year.segment$ABplus))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")
```

### Platelets
```{r, echo = FALSE}
ggplot(data = head(weekly, -1), aes(x = startdate, y = plat)) + 
  geom_line() +
  geom_smooth(data = year.segment, aes(x = startdate, y = plat), method = "lm", inherit.aes = FALSE) +
  labs(title = "All platelet products",
       subtitle = "Historical demand plus a trend line for the past year",
       caption = paste0("Past year's trend has been ", ifelse(test = lm(year.segment$plat ~ seq_along(year.segment$plat))$coefficients[2] >= 0, 
                                                              yes = "upward.", no = "downward.")),
       x = "Date",
       y = "Blood bags")
```


