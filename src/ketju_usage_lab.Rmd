---
title: "Usage Lab: Red Cells (Ketju)"
output: github_document
---

```{r setup, echo=FALSE}
# Set working directory
knitr::opts_knit$set(root.dir = "/home/esa/production_forecasts") # Working on Ubuntu
# knitr::opts_knit$set(root.dir = "V:/production_forecasts") # Working home
```

```{r imports, message=FALSE}
library(forecast)
library(ggplot2)
library(gridExtra)
library(knitr)
library(readxl)
library(plyr)
library(lubridate)
source("src/evalhelp.R")
```

# Intro
Currently under development. In this notebook we study how to use hospital blood product usage data to create demand predictions.

## Create original datasets that should remain immutable throughout labbing
```{r create_data, message=FALSE, warning=FALSE}
# Load data
# All deliveries
deliv <- read_excel("./data/ketju_data.xlsx", sheet = "Ketju-punasolutoimitukset 2014-")[, c('Päivämäärä', 'Toimitukset')]
colnames(deliv) <- c("time", "deliveries")  # Change column names
deliv$time <- as.Date(deliv$time)

# Ketju usage 2014 -->
# I'm using read.csv() instead of read_excel() here, because this sheet contains some fields that kills read_excel!
ketju <- read.csv("./data/ketju_data.csv", header = TRUE, sep = ",", colClasses=c("NULL", NA, "NULL", "NULL", "NULL", NA, "NULL", "NULL", NA, NA, NA))
colnames(ketju) <- c("hospital", "type", "time", "exp", "pcs")  # Change column names

# Ensure compliant time format with lubridate
ketju$time <- mdy(ketju$time)
ketju$exp <- mdy(ketju$exp)  # This will produce an error "failed to parse" for fields that aren't dates. It will insert NAs.

# Arrange by time
ketju <- arrange(ketju, time)

# Find usage
usage <- aggregate(ketju$pcs, by = list(ketju$time), sum); colnames(usage) <- c("time", "pcs")
```

## Histograms of how fresh blood is used across hospitals
```{r freshness_per_hospital, warning=FALSE, echo=FALSE}
# Histograms of used blood difference with expiration date per hospital

# Delete rows with missing values
ketju <- na.omit(ketju)

# Date diffs
ketju$diff <- as.numeric(ketju$exp - ketju$time)


# Plot
hmlinna <- ggplot(ketju[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("HÄMEENL") +
  ylab("count")

phks <- ggplot(ketju[ketju$hospital == "PHKS VERIKESKUS, LAHTI", ], aes(x = ketju$diff[ketju$hospital == "PHKS VERIKESKUS, LAHTI"])) + 
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("LAHTI") +
  ylab("")

tyks <- ggplot(ketju[ketju$hospital == "TYKSLAB VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "TYKSLAB VERIKESKUS"])) + 
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("TYKSLAB") +
  ylab("")

satadiag <- ggplot(ketju[ketju$hospital == "SATADIAG VERIKESKUS, RAUMA", ], aes(x = ketju$diff[ketju$hospital == "SATADIAG VERIKESKUS, RAUMA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("RAUMA") +
  ylab("")

tampere <- ggplot(ketju[ketju$hospital == "FIMLAB TAMPERE VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB TAMPERE VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("TAMPERE") +
  ylab("")

jkyla <- ggplot(ketju[ketju$hospital == "FIMLAB VERIKESKUS, JYVÄSKYLÄ", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB VERIKESKUS, JYVÄSKYLÄ"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("JKYLÄ") +
  ylab("")

kymks <- ggplot(ketju[ketju$hospital == "KYMKS VERIKESKUS, KOTKA", ], aes(x = ketju$diff[ketju$hospital == "KYMKS VERIKESKUS, KOTKA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KOTKA") +
  ylab("")

ekks <- ggplot(ketju[ketju$hospital == "EKKS VERIKESKUS, LAPPEENRANTA", ], aes(x = ketju$diff[ketju$hospital == "EKKS VERIKESKUS, LAPPEENRANTA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("LRANTA") +
  ylab("")

sjoki <- ggplot(ketju[ketju$hospital == "SEINÄJOEN KS VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "SEINÄJOEN KS VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("SJOKI") +
  ylab("")

vaasa <- ggplot(ketju[ketju$hospital == "VAASAN KS VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "VAASAN KS VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("VAASA") +
  ylab("")

kokkola <- ggplot(ketju[ketju$hospital == "NORDLAB KOKKOLA VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB KOKKOLA VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KOKKOLA") +
  ylab("")

kuopio <- ggplot(ketju[ketju$hospital == "ISLAB KUOPIO VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "ISLAB KUOPIO VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KUOPIO") +
  ylab("")

oulu <- ggplot(ketju[ketju$hospital == "NORDLAB OULU VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB OULU VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("OULU") +
  ylab("")

rovaniemi <- ggplot(ketju[ketju$hospital == "NORDLAB ROVANIEMI VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB ROVANIEMI VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("RNIEMI") +
  ylab("")

pori <- ggplot(ketju[ketju$hospital == "SATADIAG VERIKESKUS, PORI", ], aes(x = ketju$diff[ketju$hospital == "SATADIAG VERIKESKUS, PORI"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("PORI") +
  ylab("")

grid.arrange(grobs = list(hmlinna, phks, tyks, satadiag, tampere, jkyla, kymks,
                          ekks, sjoki, vaasa, kokkola, kuopio, oulu, rovaniemi, pori),
             layout_matrix = rbind(c(1, 2, 3),
                                    c(4, 5, 6),
                                    c(7, 8, 9),
                                    c(10, 11, 12),
                                    c(13, 14, 15)))
```

## Same histogram but with blood types
```{r freshness_per_type, warning=FALSE, echo=FALSE}
# Plot
Aminus <- ggplot(ketju[ketju$type == "A-", ], aes(x = ketju$diff[ketju$type == "A-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("A-") +
  ylab("count")

Aplus <- ggplot(ketju[ketju$type == "A+", ], aes(x = ketju$diff[ketju$type == "A+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("A+") +
  ylab("")

Bminus <- ggplot(ketju[ketju$type == "B-", ], aes(x = ketju$diff[ketju$type == "B-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("B-") +
  ylab("")

Bplus <- ggplot(ketju[ketju$type == "B+", ], aes(x = ketju$diff[ketju$type == "B+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("B+") +
  ylab("")

ABminus <- ggplot(ketju[ketju$type == "AB-", ], aes(x = ketju$diff[ketju$type == "AB-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("AB-") +
  ylab("")

ABplus <- ggplot(ketju[ketju$type == "AB+", ], aes(x = ketju$diff[ketju$type == "AB+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("AB+") +
  ylab("")

Ominus <- ggplot(ketju[ketju$type == "O-", ], aes(x = ketju$diff[ketju$type == "O-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("O-") +
  ylab("")

Oplus <- ggplot(ketju[ketju$type == "O+", ], aes(x = ketju$diff[ketju$type == "O+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("O+") +
  ylab("")

grid.arrange(grobs = list(Aminus, Aplus, 
                          Bminus, Bplus,
                          ABminus, ABplus, 
                          Ominus, Oplus),
             layout_matrix = rbind(c(1, 2),
                                    c(3, 4),
                                    c(5, 6),
                                    c(7, 8)))


```

## Series of usage
```{r data_goodness, warning=FALSE, message=FALSE}
# Create a convenience vector for hospital tags
hospitals <-c("FIMLAB  HÄMEENLINNA VERIKESKUS", "PHKS VERIKESKUS, LAHTI", "TYKSLAB VERIKESKUS", "SATADIAG VERIKESKUS, RAUMA", 
              "FIMLAB TAMPERE VERIKESKUS", "FIMLAB VERIKESKUS, JYVÄSKYLÄ", "KYMKS VERIKESKUS, KOTKA", "EKKS VERIKESKUS, LAPPEENRANTA", 
              "SEINÄJOEN KS VERIKESKUS", "VAASAN KS VERIKESKUS", "NORDLAB KOKKOLA VERIKESKUS", "ISLAB KUOPIO VERIKESKUS", 
              "NORDLAB OULU VERIKESKUS", "NORDLAB ROVANIEMI VERIKESKUS", "SATADIAG VERIKESKUS, PORI")
plots <- list()
i = 0
for(hospital in hospitals){
   i <- i + 1
  hospital.data <- ketju[ketju$hospital == hospital, ]
  hospital.usage <- aggregate(hospital.data$pcs, by = list(hospital.data$time), sum)
  colnames(hospital.usage) <- c("time", "pcs")
  temp <- make_whole(hospital.usage)
  hospital.whole <- temp[[1]]
  hospital.missing <- temp[[2]]

  # Plot
  hospital.plot <- ggplot() + 
    geom_line(data = hospital.whole, aes(x = time, y = pcs)) +
    geom_vline(xintercept = hospital.missing, color = "red") +
    xlab("time") +
    ggtitle(paste(hospital, "\n missing data: ", round(length(hospital.missing)/length(hospital.whole$pcs)*100, digits = 2), "%")) +
    theme(plot.title = element_text(size = 8))
  
  plots[[i]] <- hospital.plot
 
}

ml <- marrangeGrob(plots, nrow=2, ncol=2)
ml
```

The problem might be that 0s are not recorded, so we can't say what's actually missing data and what's just a data point of zero. Let's limit our explorations to 2019 for now. This probably means we'll have to exclude RAUMA.

```{r 2019_series, warning=FALSE, message=FALSE}
hospitals <- c("FIMLAB  HÄMEENLINNA VERIKESKUS", "PHKS VERIKESKUS, LAHTI", "TYKSLAB VERIKESKUS", 
              "FIMLAB TAMPERE VERIKESKUS", "FIMLAB VERIKESKUS, JYVÄSKYLÄ", "KYMKS VERIKESKUS, KOTKA", "EKKS VERIKESKUS, LAPPEENRANTA", 
              "SEINÄJOEN KS VERIKESKUS", "VAASAN KS VERIKESKUS", "NORDLAB KOKKOLA VERIKESKUS", "ISLAB KUOPIO VERIKESKUS", 
              "NORDLAB OULU VERIKESKUS", "NORDLAB ROVANIEMI VERIKESKUS", "SATADIAG VERIKESKUS, PORI")

plots <- list()
i = 0
for(hospital in hospitals){
   i <- i + 1
  hospital.data <- ketju[ketju$hospital == hospital, ]
  hospital.usage <- aggregate(hospital.data$pcs, by = list(hospital.data$time), sum)
  colnames(hospital.usage) <- c("time", "pcs")
  hospital.usage <- hospital.usage[hospital.usage$time >= as.Date("2019-01-01"), ]
  temp <- make_whole(hospital.usage)
  hospital.whole <- temp[[1]]
  hospital.missing <- temp[[2]]

  # Plot
  hospital.plot <- ggplot() + 
    geom_line(data = hospital.whole, aes(x = time, y = pcs)) +
    geom_vline(xintercept = hospital.missing, color = "red") +
    ggtitle(paste(hospital, "\n missing data: ", round(length(hospital.missing)/length(hospital.whole$pcs)*100, digits = 2), "%")) +
    theme(plot.title = element_text(size = 8)) +
    ylab("")
  
  plots[[i]] <- hospital.plot
 
}

ml <- marrangeGrob(plots, nrow=2, ncol=2)
ml

```

## Total usage across all hospitals (in 2019, *without imputation*)
```{r total_2019_wo_imput, echo=FALSE}
usage.2019 <- usage[usage$time >= "2019-01-01" & usage$time <= "2019-06-17", ]
ggplot() + geom_line(data = usage.2019, aes(x = time, y = pcs))
```

## Total usage *with imputation*
```{r}
# hospitals <- c("FIMLAB  HÄMEENLINNA VERIKESKUS", "PHKS VERIKESKUS, LAHTI", "TYKSLAB VERIKESKUS", 
#               "FIMLAB TAMPERE VERIKESKUS", "FIMLAB VERIKESKUS, JYVÄSKYLÄ", "KYMKS VERIKESKUS, KOTKA", "EKKS VERIKESKUS, LAPPEENRANTA", 
#               "SEINÄJOEN KS VERIKESKUS", "VAASAN KS VERIKESKUS", "NORDLAB KOKKOLA VERIKESKUS", "ISLAB KUOPIO VERIKESKUS", 
#               "NORDLAB OULU VERIKESKUS", "NORDLAB ROVANIEMI VERIKESKUS", "SATADIAG VERIKESKUS, PORI")
# 
# for(hospital in hospitals){
#   hospital.data <- ketju[ketju$hospital == hospital, ]
#   hospital.usage <- aggregate(hospital.data$pcs, by = list(hospital.data$time), sum)
#   colnames(hospital.usage) <- c("time", "pcs")
#   hospital.usage <- hospital.usage[hospital.usage$time >= as.Date("2019-01-01"), ]
#   temp <- make_whole(hospital.usage)
#   hospital.whole <- temp[[1]]
#   hospital.missing <- temp[[2]]
# }
# 
# total.usage <- aggregate(total$pcs, by = list(total$time), sum)
```

