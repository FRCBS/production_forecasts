---
title: "Usage Lab: Red Cells (Ketju)"
output: github_document
---

```{r setup, echo=FALSE}
# Set working directory
knitr::opts_knit$set(root.dir = "/home/esa/production_forecasts") # Working on Ubuntu
# knitr::opts_knit$set(root.dir = "V:/production_forecasts") # Working home
```

```{r imports, message=FALSE}
library(forecast)
library(ggplot2)
library(gridExtra)
library(knitr)
library(readxl)
library(plyr)
library(lubridate)
source("src/evalhelp.R")
```

# Intro
Currently under development. In this notebook we study how to use hospital blood product usage data to create demand predictions.

## Create original datasets that should remain immutable throughout labbing
```{r create_data, message=FALSE, warning=FALSE}
# Load data
# All deliveries
deliv <- read_excel("./data/ketju_data.xlsx", sheet = "Ketju-punasolutoimitukset 2014-")[, c('Päivämäärä', 'Toimitukset')]
colnames(deliv) <- c("time", "deliveries")  # Change column names
deliv$time <- as.Date(deliv$time)

# Ketju usage 2014 -->
# I'm using read.csv() instead of read_excel() here, because this sheet contains some fields that kills read_excel!
ketju <- read.csv("./data/ketju_data.csv", header = TRUE, sep = ",", colClasses=c("NULL", NA, "NULL", "NULL", "NULL", NA, "NULL", "NULL", NA, NA, NA))
colnames(ketju) <- c("hospital", "type", "time", "exp", "pcs")  # Change column names

# Ensure compliant time format with lubridate
ketju$time <- mdy(ketju$time)
ketju$exp <- mdy(ketju$exp)  # This will produce an error "failed to parse" for fields that aren't dates. It will insert NAs.

# Arrange by time
ketju <- arrange(ketju, time)

# Find usage
usage <- aggregate(ketju$pcs, by = list(ketju$time), sum); colnames(usage) <- c("time", "pcs")
```

## Histograms of how fresh blood is used across hospitals
```{r freshness_per_hospital, warning=FALSE, echo=FALSE}
# Histograms of used blood difference with expiration date per hospital

# Delete rows with missing values
ketju <- na.omit(ketju)

# Date diffs
ketju$diff <- as.numeric(ketju$exp - ketju$time)

# Plot
hmlinna <- ggplot(ketju[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("HÄMEENL") +
  ylab("count")

phks <- ggplot(ketju[ketju$hospital == "PHKS VERIKESKUS, LAHTI", ], aes(x = ketju$diff[ketju$hospital == "PHKS VERIKESKUS, LAHTI"])) + 
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("LAHTI") +
  ylab("")

tyks <- ggplot(ketju[ketju$hospital == "TYKSLAB VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "TYKSLAB VERIKESKUS"])) + 
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("TYKSLAB") +
  ylab("")

satadiag <- ggplot(ketju[ketju$hospital == "SATADIAG VERIKESKUS, RAUMA", ], aes(x = ketju$diff[ketju$hospital == "SATADIAG VERIKESKUS, RAUMA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("RAUMA") +
  ylab("")

tampere <- ggplot(ketju[ketju$hospital == "FIMLAB TAMPERE VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB TAMPERE VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("TAMPERE") +
  ylab("")

jkyla <- ggplot(ketju[ketju$hospital == "FIMLAB VERIKESKUS, JYVÄSKYLÄ", ], aes(x = ketju$diff[ketju$hospital == "FIMLAB VERIKESKUS, JYVÄSKYLÄ"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("JKYLÄ") +
  ylab("")

kymks <- ggplot(ketju[ketju$hospital == "KYMKS VERIKESKUS, KOTKA", ], aes(x = ketju$diff[ketju$hospital == "KYMKS VERIKESKUS, KOTKA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KOTKA") +
  ylab("")

ekks <- ggplot(ketju[ketju$hospital == "EKKS VERIKESKUS, LAPPEENRANTA", ], aes(x = ketju$diff[ketju$hospital == "EKKS VERIKESKUS, LAPPEENRANTA"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("LRANTA") +
  ylab("")

sjoki <- ggplot(ketju[ketju$hospital == "SEINÄJOEN KS VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "SEINÄJOEN KS VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("SJOKI") +
  ylab("")

vaasa <- ggplot(ketju[ketju$hospital == "VAASAN KS VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "VAASAN KS VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("VAASA") +
  ylab("")

kokkola <- ggplot(ketju[ketju$hospital == "NORDLAB KOKKOLA VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB KOKKOLA VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KOKKOLA") +
  ylab("")

kuopio <- ggplot(ketju[ketju$hospital == "ISLAB KUOPIO VERIKESKUSI", ], aes(x = ketju$diff[ketju$hospital == "ISLAB KUOPIO VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("KUOPIO") +
  ylab("")

oulu <- ggplot(ketju[ketju$hospital == "NORDLAB OULU VERIKESKUS", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB OULU VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("OULU") +
  ylab("")

rovaniemi <- ggplot(ketju[ketju$hospital == "NORDLAB ROVANIEMI VERIKESKUSI", ], aes(x = ketju$diff[ketju$hospital == "NORDLAB ROVANIEMI VERIKESKUS"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("RNIEMI") +
  ylab("")

pori <- ggplot(ketju[ketju$hospital == "SATADIAG VERIKESKUS, PORI", ], aes(x = ketju$diff[ketju$hospital == "SATADIAG VERIKESKUS, PORI"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("PORI") +
  ylab("")

grid.arrange(grobs = list(hmlinna, phks, tyks, satadiag, tampere, jkyla, kymks,
                          ekks, sjoki, vaasa, kokkola, kuopio, oulu, rovaniemi, pori),
             layout_matrix = rbind(c(1, 2, 3),
                                    c(4, 5, 6),
                                    c(7, 8, 9),
                                    c(10, 11, 12),
                                    c(13, 14, 15)))
```

## Same histogram but with blood types
```{r freshness_per_type, warning=FALSE, echo=FALSE}
# Plot
Aminus <- ggplot(ketju[ketju$type == "A-", ], aes(x = ketju$diff[ketju$type == "A-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("A-") +
  ylab("count")

Aplus <- ggplot(ketju[ketju$type == "A+", ], aes(x = ketju$diff[ketju$type == "A+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("A+") +
  ylab("")

Bminus <- ggplot(ketju[ketju$type == "B-", ], aes(x = ketju$diff[ketju$type == "B-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("B-") +
  ylab("")

Bplus <- ggplot(ketju[ketju$type == "B+", ], aes(x = ketju$diff[ketju$type == "B+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("B+") +
  ylab("")

ABminus <- ggplot(ketju[ketju$type == "AB-", ], aes(x = ketju$diff[ketju$type == "AB-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("AB-") +
  ylab("")

ABplus <- ggplot(ketju[ketju$type == "AB+", ], aes(x = ketju$diff[ketju$type == "AB+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("AB+") +
  ylab("")

Ominus <- ggplot(ketju[ketju$type == "O-", ], aes(x = ketju$diff[ketju$type == "O-"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("O-") +
  ylab("")

Oplus <- ggplot(ketju[ketju$type == "O+", ], aes(x = ketju$diff[ketju$type == "O+"])) +
  geom_histogram(bins = 30, color = "black", fill = "#DF013A") +
  xlim(c(0, 35)) +
  xlab("O+") +
  ylab("")

grid.arrange(grobs = list(Aminus, Aplus, 
                          Bminus, Bplus,
                          ABminus, ABplus, 
                          Ominus, Oplus),
             layout_matrix = rbind(c(1, 2),
                                    c(3, 4),
                                    c(5, 6),
                                    c(7, 8)))


```

## Series of usage
```{r}
all.dates <- seq.Date(
  min()
)

hlinna.data <- ketju[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS", ]
usage.hlinna <- aggregate(hlinna.data$pcs, by = list(hlinna.data$time), sum); colnames(usage.hlinna) <- c("time", "pcs")
# ts.hlinna <- ts(aggregate(ketju[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS", ]$pcs, by = list(ketju[ketju$hospital == "FIMLAB  HÄMEENLINNA VERIKESKUS", ]$time), sum)$x, start = 2014, frequency = 365)
# autoplot(window(ts.hlinna, start = 2019))
```


Check if the series have missing days
```{r}
date_range <- seq(min(deliv$time), max(deliv$time), by = 1)
date_range[!date_range %in% deliv$time]
```

The deliveries are missing 24 days. We will impute.

```{r}
deliv.imputed <- as.data.frame(rbind(deliv,
                                     c("2014-01-26", deliv$deliveries[deliv$time == "2014-01-19"]),
                                     c("2014-03-09", deliv$deliveries[deliv$time == "2014-03-02"]),
                                     c("2015-01-18", deliv$deliveries[deliv$time == "2015-01-11"]),
                                     c("2015-03-29", deliv$deliveries[deliv$time == "2015-03-22"]),
                                     c("2015-06-27", deliv$deliveries[deliv$time == "2015-06-20"]),
                                     c("2016-08-07", deliv$deliveries[deliv$time == "2016-07-31"]),
                                     c("2016-11-06", deliv$deliveries[deliv$time == "2016-10-30"]),
                                     c("2017-01-06", deliv$deliveries[deliv$time == "2016-12-30"]),
                                     c("2017-02-12", deliv$deliveries[deliv$time == "2017-02-05"]),
                                     c("2017-04-02", deliv$deliveries[deliv$time == "2017-03-26"]),
                                     c("2017-05-21", deliv$deliveries[deliv$time == "2017-05-14"]),
                                     c("2017-06-25", deliv$deliveries[deliv$time == "2017-06-18"]),
                                     c("2017-07-30", deliv$deliveries[deliv$time == "2017-07-23"]),
                                     c("2018-01-14", deliv$deliveries[deliv$time == "2018-01-07"]),
                                     c("2018-02-04", deliv$deliveries[deliv$time == "2018-01-28"]),
                                     c("2018-05-26", deliv$deliveries[deliv$time == "2018-05-19"]),
                                     c("2018-06-03", deliv$deliveries[deliv$time == "2018-05-27"]),
                                     c("2018-06-10", deliv$deliveries[deliv$time == "2018-06-04"]),
                                     c("2018-07-21", deliv$deliveries[deliv$time == "2018-07-14"]),
                                     c("2018-08-19", deliv$deliveries[deliv$time == "2018-08-12"]),
                                     c("2019-02-24", deliv$deliveries[deliv$time == "2019-02-17"]),
                                     c("2019-03-02", deliv$deliveries[deliv$time == "2019-02-23"]),
                                     c("2019-03-09", deliv$deliveries[deliv$time == "2019-03-03"]),
                                     c("2019-04-28", deliv$deliveries[deliv$time == "2019-04-21"]))); colnames(deliv.imputed) <- c("time", "deliveries")

deliv.imputed <- arrange(deliv.imputed, time)
```


```{r}
date_range <- seq(min(deliv.imputed$time), max(deliv.imputed$time), by = 1)
date_range[!date_range %in% deliv.imputed$time]
```


## Create time series
```{r}
ts.deliv <- ts(deliv.imputed$deliveries, start = 2014, frequency = 365)
ts.usage <- ts(usage$pcs, start = 2014, frequency = 365)
```


```{r}
Deliveries <- window(ts.deliv, start = 2019, end = c(2019, 31))
Usage <- window(ts.usage, start = 2019, end = c(2019, 31))
ggplot() + 
  autolayer(Deliveries) + 
  autolayer(Usage) + 
  ggtitle("Ketju-menekki vs. Ketju-toimitukset 2019") +
  ylab("Units") +
  xlab("Time") +
  scale_fill_discrete(name = "Series", labels = c("Deliveries", "Usage")) +
  theme(legend.position = "bottom")
```


```{r}
# Plot
usage.c <- ts(cumsum(usage$pcs), start = 2014, frequency = 365)
deliv.c <- ts(cumsum(deliv.imputed$deliveries), start = 2014, frequency = 365)
difference <- tail(cumsum(deliv.imputed$deliveries), 1) - tail(cumsum(usage$pcs), 1)
ggplot() + 
  autolayer(usage.c) + 
  autolayer(deliv.c) + 
  ylab("Units") +
  xlab("Time") +
  ggtitle(paste("Cumsum difference at end of series: ", difference))
```

There exists a 6% difference between deliveries and usage at the end of series. This is due to the fact that not all blood bags get used that get delivered!
