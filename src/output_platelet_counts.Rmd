---
title: "Production Forecasts"
output: html_document
author: "Mikko Arvas"
date: "`r format(Sys.time(), '%d %B, %Y')`"

---
```{r setup, echo = FALSE}
#echo "rmarkdown::render('output_platelet_counts.Rmd', clean=TRUE,output_file='../results/output_platelet_counts.20200611.html')" | R --slave 
# Set working directory
setwd("~/Work/proj/2019Summer/production_forecasts/src/")
```



```{r imports, message = FALSE, echo = FALSE}

library(ggplot2)
library(gridExtra)
library(knitr)
library(lubridate)
library(data.table)
library(tidyverse)
#source("src/pffunctions.R")
```


# Read in data

```{r read_files, include = TRUE, warning=FALSE}
#Get the facility codes
# I had to resort to perl as the gsub below was not complete enough
#$ perl -pe 's/[[:^ascii:]]//g;' facility.txt | perl -pe "s/\"|\'//g" > facility.clean.txt
#
#facility <- as_tibble(read.table("../data/facility.txt",sep = "\t",fill = TRUE,header = TRUE,colClasses = c("character"))[,c(1,2)])
facility <- as_tibble(read.table("../data/facility.clean.txt",sep = "\t",fill = TRUE,header = TRUE,colClasses = c("character"))[,c(1,2)])
facility$AccountNum <- paste0("F",as.character(facility$AccountNum))

#facility$Name <- gsub("[^[:alnum:][:blank:]?&/\\-]", "", facility$Name)

# Get all the files
#PATH <- "/home/esa/production_forecasts/data/FACS/"
PATH <- "~/Work/proj/2019Summer/production_forecasts/data/FACS/"
files <- list.files(path = PATH, pattern = "FAC0091_*")  # Character vector of file names

# Compile a dataframe by going over all files
dlist <- list()
for (i in files) {
  # Read a single file to a df called d
  d <- read.delim(file = paste0(PATH, "/", i), header = FALSE, sep = ";", stringsAsFactors = FALSE, colClasses = 'character')
  
  if(length(d) == 26){
    d <- d[, !(names(d) %in% c("V10"))]  # The column numbers unfortunately vary between files, so we'll adjust
    }
  colnames(d) <- c("V1", "V2", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10",
                   "V11", "V12", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "V20",
                   "V21", "V22", "V23", "V24", "V25")  # This is done so as to have easier column handling later on
  dlist[[i]] <- d
}

d <- as.data.frame(rbindlist(dlist, fill = TRUE))
```

#Format data set

```{r modify_dataframe, include = TRUE}
# Divide into distributions (P) and returns (R)
P <- d[d$V1 == "P", ]
R <- d[d$V1 == "R", ]

# For distributions, we'll keep Distribution date, Quantity, Exp date
keep <- c("V12", "V14", "V18", "V22", "V24","V2")
distr <- P[keep]
colnames(distr) <- c("date", "product", "quantity", "volume", "exp","facility")
#Transfrom facility codes into 4 digit numbers
distr$facility <- paste0("F",unlist(lapply(distr$facility,function(x){substr(x,start=nchar(x) -3,stop = nchar(x))})))

#Unfortunately the format of changes in time
R1<- split(x=R,f=nchar(R$V14) == 0)[[1]]
R2<- split(x=R,f=nchar(R$V14) == 0)[[2]]
# For returns we keep the return date and quantity
keep <- c("V4","V5", "V7","V14")
retrn1 <- R1[keep]
keep <- c("V4","V5", "V7","V13")
retrn2 <- R2[keep]

colnames(retrn1) <- c("date", "product","quantity","facility")
colnames(retrn2) <- c("date", "product","quantity","facility")
retrn <- rbind(retrn1,retrn2)
#Transfrom facility codes into 4 digit numbers
retrn$facility <- paste0("F",unlist(lapply(retrn$facility,function(x){substr(x,start=nchar(x) -3,stop = nchar(x))})))

# Datify
distr$date <- dmy(distr$date); distr$exp <- dmy(distr$exp)
retrn$date <- dmy(retrn$date)

# Numerify
distr$quantity <- as.numeric(distr$quantity); distr$volume <- as.numeric(distr$volume)
retrn$quantity <- as.numeric(retrn$quantity)


# Product codes for platelets
#plat.codes <- c("budTR002", "trEnnApu", "A0004V00", "A0005V00", "A0006V00", "A0007V00", "A0008V00",
#"budTR002", "trEnnApu" are not sold products
plat.codes <- c("A0004V00", "A0005V00", "A0006V00", "A0007V00", "A0008V00",
                "A0086VA0", "A0086VB0", "A0086V00", "A0088V00", "A0088VA0", "A0088VB0", "A0089V00",
                "A0089VB0", "A0089VA0", "A0090V00", "A0090VA0", "A0090VB0", "A0018V00", "A0020V00", 
                "A0021V00", "A0021VA0", "A0021VB0", "A0047V00", "A0049V00", "A0051V00", "A0054V00",
                "A0055V00", "A0056V00", "A0057V00", "A0059V00", "A0060V00", "A0067VA0", "A0067VB0",
                "A0067V00", "A0068VA0", "A0068VB0", "A0068V00", "A0075V00", "A0101V00", "A0102V00",
                "E3949V00", "E3953V00", "E3954V00", "E3955V00", "E3956V00", "E3957V00", "E3958V00",
                "E3959V00", "E3960V00", "E3961V00", "E3962V00", "E3963V00", "E3964V00", "E3965V00", 
                "E3966V00", "E3968VA0", "E3968VB0", "E3968V00", "E3970V00", "E3971V00", "E3973V00",
                "E3974V00", "E3976V00", "E3981V00", "E3995V00", "E3996V00", "E3997V00", "E3997VA0",
                "E3997VB0", "E4002V00", "E4004V00", "E6782V00", "E6783V00", "E6953V00", "E6860V00",
                "E6874VA0", "E6874V00", "E6874VB0", "E6875VB0", "E6875V00", "E7530V00", "E7530VA0",
                "E7530VB0", "E7531V00", "E7531VA0", "E7531VB0", "E6875VA0")

plat.distr <- distr[distr$product %in% plat.codes, ] %>% arrange(date)
plat.retrn <- retrn[retrn$product %in% plat.codes, ] %>% arrange(date)

#Label facilities
plat.distr <- left_join(plat.distr,facility,by = c("facility"="AccountNum"))
retrn.distr <- left_join(plat.retrn,facility,by = c("facility"="AccountNum"))


```

Data starts from `r min(plat.distr$date)`.


#Check the products

```{r}

p  <- ggplot(plat.distr,aes(x=product))
p <- p + geom_bar() + theme(axis.text.x = element_text(angle = 90))
p <- p + geom_text(stat='count', aes(label=..count..), vjust=-1)
p
```

Looks like some of them are very rare. 


```{r}
plat.distr %>% group_by(product) %>% summarise(n=n()) %>% filter(n <100)
```

How do they change over time?

```{r}
# Get the ones with over 2000 deliveries

over2000 <- plat.distr %>% group_by(product) %>% summarise(n=n()) %>% filter(n > 2000)
yearlycounts<- plat.distr %>% mutate(year=year(date)) %>% group_by(product,year) %>% summarise(n=n()) %>% filter(year > 2013 & year < 2020 )
yearlycounts<- yearlycounts %>% filter(product %in% over2000$product)

p <- ggplot(yearlycounts,aes(x=year,y=n))
p <- p + geom_line() + facet_wrap(~product)
p
```


**Should some products be dropped out?**

**Can all products be counted the same?**

Tiia says no. All can be counted the same.

#Check the volumes
Is there varition in volumes of products with over 2000 deliveries?


```{r}
summary(plat.distr$volume)


```
Wow, nasty!

```{r}
#Strange volumes above 400
plat.distr %>% filter(volume > 400) %>% select(product,volume,facility)
```

Let's drop them out
```{r}
plat.distr <- plat.distr %>% filter(volume <400)
```


```{r}
pd <- plat.distr %>% filter(product %in% over2000$product)
p <- ggplot(pd)
p <- p + geom_bar(aes(x=volume),fill='red') + facet_grid(~product) + theme(axis.text.x = element_text(angle = 90))
p
```

E6953V00 has a lot of ~160 volumes.

**Are they still to be counted as one delivery?**

Yes, as Tiia already said. They can be all counted as one :-)!

# Check the facilities and their names

`r length(unique(plat.distr$facility) )` facility codes.
`r length(unique(plat.distr$Name) )` facility names.

```{r}
p  <- ggplot(plat.distr,aes(x=facility))
p <- p + geom_bar() + theme(axis.text.x = element_text(angle = 90))
p <- p + geom_text(stat='count', aes(label=..count..), vjust=-1)
p

```



```{r}

atleast1000 <- plat.distr %>% group_by(Name,facility) %>%  summarise(n=n(),LastYear=year(last(date)))  %>% ungroup() %>%  filter(n > 999) %>% arrange(desc(n)) 
atleast1000 %>% select(-Name)
```

There are `r nrow(atleast1000)` facilities with atleast 1000 platellet products delivered in the data set.



How to they change in time?

```{r}
# Get the ones with over 2000 deliveries

if (FALSE) {
  # if you want to so the names a bit
  yearlycounts<- plat.distr %>% mutate(year=year(date)) %>% group_by(facility,year) %>% summarise(n=n(), name=paste0(last(facility)," " ,substr(last(Name),0,10))) %>% filter(year > 2013 & year < 2020 )
} else {
  yearlycounts<- plat.distr %>% mutate(year=year(date)) %>% group_by(facility,year) %>% summarise(n=n(),name=last(facility)) %>% filter(year > 2013 & year < 2020 )
}
yearlycounts<- yearlycounts %>% filter(facility %in% atleast1000$facility) %>% ungroup()

p <- ggplot(yearlycounts,aes(x=year,y=n))
p <- p + geom_line() + facet_wrap(~name) + theme(axis.text.x = element_text(angle = 90))
p
```



```{r}
leastDeliveries <- plat.distr %>% group_by(Name,facility) %>%  summarise(n=n(),LastYear=year(last(date))) %>% ungroup() %>% top_n(-10) %>% arrange(n)
leastDeliveries$n[leastDeliveries$n < 6] <- "1-5"
leastDeliveries %>% select(-Name)
```


```{r}
leastDeliveries %>% filter(is.na(Name)) %>% select(-Name)

```

The two lacking facility names are in here. So we do not need to worry about them.



**Do we want to limit to some facilities only?**

Probably we want to limit ourselves to big hospitals only:
F8116 TAYS
F8070 TYKS
F7109 HUS
F8316 OYS


```{r , warning=FALSE}
length(grep("HUS",unique(plat.distr$Name),value = TRUE))
```
Quite a few places under HUS.  

**Do we want to group some facilities?**
Maybe F7109 will do for HUS.

#Return data
```{r}
yearlyreturns <- plat.retrn %>% mutate(year=year(date)) %>% group_by(year) %>% summarise( n=n() ) %>% filter(year > 2013 & year < 2020 )
 
p <- ggplot(yearlyreturns,aes(x=year, y=n))
p <- p + geom_line()
p
```

```{r}
plat.retrn %>% group_by(facility) %>% count() %>% arrange(desc(n)) %>%  head()
```

```{r}
plat.retrn %>% group_by(facility) %>% count() %>% arrange(desc(n)) %>%  tail()
```


**Do we want to somehow take returns into account?**
Add them in later

#Example data

```{r}
#Accept all the products
#Only take these facilites 
#"F8116","F8070","F7109","F8316"

dailycounts <- plat.distr %>% filter(facility %in% c("F8116","F8070","F7109","F8316")) %>%  group_by(Name,date) %>%  summarise(n=n())
#To anonymise make all counts of 1-5 as "1-5"
dailycounts$n[dailycounts$n < 6] <- "1-5"
dailycounts$Name <- as.factor(dailycounts$Name)
levels(dailycounts$Name) <- c("TAYS","HUS","OYS","TYKS")
dailycounts

```

But how many are then actually 1-5?

```{r}
freqs <- dailycounts %>% ungroup %>% select(-Name) %>% count(n) %>% arrange(nn)

p <- ggplot(freqs,aes(y=nn,x=n))
p <- p + geom_col() + theme(axis.text.x = element_text(angle = 90))
#p <- p + geom_text(stat='count', aes(label=..count..), vjust=-1)
p
```


```{r}
freqs <- dailycounts %>% group_by(Name) %>% count(n) %>% arrange(nn)

p <- ggplot(freqs,aes(y=nn,x=n))
p <- p + geom_col() + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Name)
#p <- p + geom_text(stat='count', aes(label=..count..), vjust=-1)
p
```


Looks a bit funny, but it could do. ** Ellie says it is OK**

# All hospitals
Tiia thought it would be best to include all hospitals in the delivery.
```{r}
library("xlsx")
hospitals <- read.xlsx("../data/SairaalaAsiakkaat2012_Tiilta.xlsx",sheetIndex = 1)
hcode  <- paste0("F",gsub(" .*","",gsub("^ ","",hospitals[,1])))
hname  <- substr(x=sub("^ ","",hospitals[,1]),start = 7,stop = 50)
hospitals <- data.frame(facility = hcode,name=hname)
```


```{r}
#Accept all the products
#Only take jhospitals 
#"F8116","F8070","F7109","F8316"

dailycounts <- plat.distr %>% filter(facility %in% hospitals$facility)   %>%  group_by(facility,date) %>%  summarise(n=n())
#Names come put much better from the Hospitals object
dailycounts <- inner_join(dailycounts,hospitals, by = c("facility"="facility")) %>% ungroup() %>% select(-facility)

```

## Provide descriptives of counts

First bin the hospitals a bit based on delivires in year 2019
```{r}
count2019<- dailycounts %>% filter(date >= "2019-01-01"  & date <= "2019-12-31") %>%  group_by(name) %>% summarise(count=sum(n))
ggplot(count2019) + geom_histogram(aes(x=count),binwidth = 100)  

```
```{r}

ggplot(count2019 %>% filter(count < 1000)) + geom_histogram(aes(x=count),binwidth = 50)  

```

Based on that lets bin them by 100 and 1000.

```{r}
count2019 <- count2019 %>% mutate( size = case_when(count < 100 ~ "small",
                                       count >= 100 & count < 1000 ~ "medium",
                                       count >= 1000 ~ "large" )
                      )

dailycounts<- left_join(dailycounts,count2019,by=c("name"="name")) %>% select(-count)
#Mark NAs as small
dailycounts$size[is.na(dailycounts$size)] <- "small" 
```


Summarise by group and year

```{r}
#https://www.r-bloggers.com/computing-the-mode-in-r/
Mode = function(x){
    ta = table(x)
    tam = max(ta)
    if (all(ta == tam))
         mod = NA
    else
         if(is.numeric(x))
    mod = as.numeric(names(ta)[ta == tam])
    else
         mod = names(ta)[ta == tam]
    return(mod)
}


descs <- dailycounts %>% mutate(year=year(date)) %>% group_by(size,year) %>% summarise(mean=mean(n),
                                                                              sd=sd(n),
                                                                              median=median(n),
                                                                              q25=quantile(n,0.25),
                                                                              q75=quantile(n,0.75),
                                                                              mode1=Mode(n)[1],
                                                                              mode2=Mode(n)[2]
                                                                              )

write.csv(descs,file="../results/20200611delivery_descs.csv",row.names = FALSE)
```


```{r}
#To anonymise make all counts of 1-5 as "1-5"
dailycounts$n[dailycounts$n < 6] <- "1-5"
dailycounts$class <- "delivery"
dailycounts

```

## Add the returns
```{r}
#add the names
returns <- inner_join(plat.retrn,hospitals, by = c("facility"="facility")) %>% select(-facility)
dailyreturns <- returns %>%  group_by(name,date) %>%  summarise(n=n())
dailyreturns$class <- "return"
dailyreturns <- dailyreturns %>% select(date,n,name,class)
#Add the size class
dailyreturns<- left_join(dailyreturns,count2019,by=c("name"="name")) %>% select(-count)
#Mark NAs as small
dailyreturns$size[is.na(dailyreturns$size)] <- "small" 

#dailyreturns


```


```{r}
descs <- dailyreturns %>% mutate(year=year(date)) %>% group_by(size,year) %>% summarise(mean=mean(n),
                                                                              sd=sd(n),
                                                                              median=median(n),
                                                                              q25=quantile(n,0.25),
                                                                              q75=quantile(n,0.75),
                                                                              mode1=Mode(n)[1],
                                                                              mode2=Mode(n)[2]
                                                                              )

write.csv(descs,file="../results/20200611returns_descs.csv",row.names = FALSE)
descs

```



Anomymise and join 
```{r}
#To anonymise make all counts of 1-5 as "1-5"
dailyreturns$n[dailyreturns$n < 6] <- "1-5"

daily <- bind_rows(dailycounts,dailyreturns) %>% ungroup()%>% arrange(date)

head(daily)

```



```{r}
tail(daily)
```


## Summarise a bit
```{r}
daily %>% mutate(Year=year(date)) %>% group_by(Year,class) %>% count() %>% tail(10)
```

This is not counts of bags but counts of days with a delivery or return to/from hospital.

```{r}
daily %>% group_by(name,class) %>% count() %>% arrange(desc(n)) %>% head(10)
```

```{r}
daily %>% group_by(name,class) %>% count() %>% arrange(desc(n)) %>% tail(10)
```
This is not counts of bags but counts of days with a delivery or return to/from hospital.

Looks OK. 
```{r}
file <- "../results/20200611DailyCountsOfPlateletReturnsAndDeliveries.txt"
write.table(daily,file=file,sep = ";",row.names = FALSE,quote = FALSE)
```

