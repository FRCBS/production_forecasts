---
title: "model_selection_tests"
author: "Esa Turkulainen"
date: "3/8/2021"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# echo "rmarkdown::render('forecast_script_FIN.Rmd', clean=TRUE,output_format='html_document',output_file='results/forecast_script_FIN_20201006.Rmd')" | R --slave

# Set working directory
ROOTDIR <- "~/production_forecasts/src/" # Your directory
DATADIR <- "~/production_forecasts/data/FACS"
HISTORYDIR <- "~/production_forecasts/histories/" # monthly
MONTHLYDIR <- paste0(HISTORYDIR, "monthly_") # monthly
WEEKLYDIR <- paste0(HISTORYDIR, "weekly_") # weekly

knitr::opts_chunk$set(root.dir = ROOTDIR, warning = FALSE, message = FALSE) # No warnings for final output
knitr::opts_knit$set(root.dir = ROOTDIR, warning = FALSE, message = FALSE)

# Colorblind palette
# black, orange, sky blue, green,
# yellow, blue, vermilion, purple
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# These colors work server side for now:
palette <- list(1, 1, 1, 0.7, "royalblue2", "deepskyblue1", "darkred", "darkgreen")
names(palette) <- c("alpha80", "alpha95", "alphaSeg", "alphaPred", "fill80", "fill95", "colPred", "colData")
```

```{r imports, message=FALSE, warning=FALSE, echo=FALSE}
library(forecast)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(knitr)
library(plyr)
library(lubridate)
library(numbers)
library(data.table)
library(R.utils)
library(DT)
library(stringr)
library(hash)
library(htmltools)
library(feasts)
library(tsibble)
library(dplyr)
library(zoo)
library(scales)
library(grid)
library(ggbiplot)
source("pffunctions.R")
# Set rolling window size in years
rw_years <- 3
start_date <- as.Date("2014-01-01")
```

## Here we test the hypothesis that the pool of models are so flexible that their forecasts often overlap without much difference in error.

Load prepared data from 2014.
```{r}
monthly <- read.csv("/home/esa/production_forecasts/data/monthly_2014.csv", colClasses = c("Date", "numeric", "numeric", "numeric"))
monthly_real <- read.csv("/home/esa/production_forecasts/data/monthly_real_2014.csv", colClasses = c("Date", "numeric", "numeric", "numeric"))
```

Use the rolling window procedure to generate forecasts for several labels separately.
```{r}
history <- head(monthly, -1)
rw_years <- 3 # ensure 3 yr rolling window
type <- "red"
modelnames <- c("SNAIVE", "5-MA", "7-MA", "9-MA", "12-MA", "STL", "ETS", "TBATS", "STLF", "ARIMAX", "DYNREG", "NN", "COMBINED")

pb = txtProgressBar(min = 0, max = length(modelnames), initial = 0, style = 3) # Progress Bar for fun

for(j in 1:length(modelnames)){
  N <- length(history$date) - 12 * (rw_years + 1) # Preallocate rows
  forecast.history <- data.frame(time = rep(as.Date(tail(history$date, (rw_years + 1) * 12)[1]), N),
                                 model = rep("", N),
                                 forecast = rep(NA, N),
                                 upper80 = rep(NA, N),
                                 upper95 = rep(NA, N),
                                 lower80 = rep(NA, N),
                                 lower95 = rep(NA, N),
                                 stringsAsFactors = F)
  
  for(i in seq(0, (N - 1))){
  cutreal <- head(history, -(N - i)) # Erase (N-x) months from real history
  beginning <- tail(cutreal$date, (((rw_years + 1) * 12) + 1))[1] # Define beginning of window
  segment <- head(tail(cutreal[, type], (((rw_years + 1) * 12) + 1)), ((rw_years + 1) * 12)) # Define window
  series.ts <- ts(segment, start = c(year(beginning), month(beginning), day(beginning)), frequency = 12) # Transform into a ts object
  
  scale_start <- cutreal$date[length(cutreal$date)]
  scaleback <- as.numeric(bizdays(ts(seq(1),
                                   start = c(year(scale_start), month(scale_start), day(scale_start)),
                                   frequency = 12), FinCenter = "Zurich")) # Scaler for saving
  
  # Forecast
  chosen.model <- j
  mcast <- chosen_forecast(chosen.model, series.ts, history, freq = "monthly", rw_years) # Output a forecast
  missing.fcast <- data.frame(time = tail(cutreal$date, 1),
                              model = modelnames[chosen.model],
                              forecast = mcast$fcast[1] * scaleback,
                              upper80 = mcast$upper80[1] * scaleback,
                              upper95 = mcast$upper95[1] * scaleback,
                              lower80 = mcast$lower80[1] * scaleback,
                              lower95 = mcast$lower95[1] * scaleback, stringsAsFactors = FALSE)
  forecast.history[(i+1), ] <- missing.fcast

  }
  # Save into a csv
  modelname <- modelnames[j]
  write.csv(forecast.history, file = paste0("/home/esa/production_forecasts/histories/", modelname, "2", "_fcast_history.csv"), row.names = FALSE)
  setTxtProgressBar(pb, j) # Update progress bar
}
```
Now load all forecasts into a masterframe (for plotting and analysis).
```{r}
truth <- monthly_real[48:78, 1:2]
for(i in 1:length(modelnames)){
  modelname <- modelnames[i]
  column <- read.csv(paste0("/home/esa/production_forecasts/histories/", modelname, "2", "_fcast_history.csv"), colClasses = c("NULL", "NULL", "numeric", "NULL", "NULL", "NULL", "NULL"))
  truth <- cbind(truth, column)
}
colnames(truth) <- c("date", "red", modelnames)
```

```{r}
tail(truth)
```
Let's see how they look.
```{r}
ggplot(data = truth, aes(x = date)) + 
  geom_line(aes(y = red), size = 1.35) +
  geom_line(aes(date, SNAIVE), color = "red", size = 1.1) + 
  geom_line(aes(date, STL), color = "orange", size = 1.1) +
  geom_line(aes(date, DYNREG), color = "blue", size = 1.1) +
  geom_line(aes(date, ARIMAX), color = "dark green", size = 1.1) +
  geom_line(aes(date, TBATS), color = "purple", size = 1.1) +
  geom_line(aes(date, STLF), color = "pink", size = 1.1) +
  theme_minimal()
```
To compare with the other data set, we'll also calculate the best model each month out of those plotted.
```{r}
truth <- select(truth, c("date", "red", "SNAIVE", "STL", "STLF", "DYNREG", "ARIMAX", "TBATS"))
errdf <- abs(truth$red - truth[, 3:8])
```

```{r}
truth$best <- colnames(errdf)[apply(errdf, 1, which.min)]
```

```{r}
truth
```
Load prepared data from 2004.
```{r}
monthly2 <- read.csv("/home/esa/production_forecasts/data/monthly_2004.csv", colClasses = c("Date", "numeric", "NULL"))
monthly_real2 <- read.csv("/home/esa/production_forecasts/data/monthly_real_2004.csv", colClasses = c("Date", "numeric", "NULL"))

monthly2 <- monthly2[which(monthly2$date >= as.Date("2014-01-01")), ]
monthly_real2 <- monthly_real2[which(monthly_real2$date >= as.Date("2014-01-01")), ]
```

Use the rolling window procedure to generate forecasts for several labels separately.
```{r}
history <- monthly2
rw_years <- 3 # ensure 3 yr rolling window
type <- "red"
modelnames <- c("SNAIVE", "5-MA", "7-MA", "9-MA", "12-MA", "STL", "ETS", "TBATS", "STLF", "ARIMAX", "DYNREG", "NN", "COMBINED")

pb = txtProgressBar(min = 0, max = length(modelnames), initial = 0, style = 3) # Progress Bar for fun

for(j in 1:length(modelnames)){
  N <- length(history$date) - 12 * (rw_years + 1) # Preallocate rows
  forecast.history <- data.frame(time = rep(as.Date(tail(history$date, (rw_years + 1) * 12)[1]), N),
                                 model = rep("", N),
                                 forecast = rep(NA, N),
                                 upper80 = rep(NA, N),
                                 upper95 = rep(NA, N),
                                 lower80 = rep(NA, N),
                                 lower95 = rep(NA, N),
                                 stringsAsFactors = F)
  
  for(i in seq(0, (N - 1))){
  cutreal <- head(history, -(N - i)) # Erase (N-x) months from real history
  beginning <- tail(cutreal$date, (((rw_years + 1) * 12) + 1))[1] # Define beginning of window
  segment <- head(tail(cutreal[, type], (((rw_years + 1) * 12) + 1)), ((rw_years + 1) * 12)) # Define window
  series.ts <- ts(segment, start = c(year(beginning), month(beginning), day(beginning)), frequency = 12) # Transform into a ts object
  
  scale_start <- cutreal$date[length(cutreal$date)]
  scaleback <- as.numeric(bizdays(ts(seq(1),
                                   start = c(year(scale_start), month(scale_start), day(scale_start)),
                                   frequency = 12), FinCenter = "Zurich")) # Scaler for saving
  
  # Forecast
  chosen.model <- j
  mcast <- chosen_forecast(chosen.model, series.ts, history, freq = "monthly", rw_years) # Output a forecast
  missing.fcast <- data.frame(time = tail(cutreal$date, 1),
                              model = modelnames[chosen.model],
                              forecast = mcast$fcast[1] * scaleback,
                              upper80 = mcast$upper80[1] * scaleback,
                              upper95 = mcast$upper95[1] * scaleback,
                              lower80 = mcast$lower80[1] * scaleback,
                              lower95 = mcast$lower95[1] * scaleback, stringsAsFactors = FALSE)
  forecast.history[(i+1), ] <- missing.fcast

  }
  # Save into a csv
  modelname <- modelnames[j]
  write.csv(forecast.history, file = paste0("/home/esa/production_forecasts/histories/", modelname, "_fcast_alt_history.csv"), row.names = FALSE)
  setTxtProgressBar(pb, j) # Update progress bar
}
```

Now load all forecasts into an alternate masterframe (for plotting and analysis).
```{r}
alt_truth <- monthly_real2[ 48:78, 1:2]
for(i in 1:length(modelnames)){
  modelname <- modelnames[i]
  column <- read.csv(paste0("/home/esa/production_forecasts/histories/", modelname, "_fcast_alt_history.csv"), colClasses = c("NULL", "NULL", "numeric", "NULL", "NULL", "NULL", "NULL"))
  alt_truth <- cbind(alt_truth, column)
}
colnames(alt_truth) <- c("date", "red", modelnames)
```

```{r}
tail(alt_truth)
```

Let's see how they look.
```{r}
ggplot(data = alt_truth, aes(x = date)) + 
  geom_line(aes(y = red), size = 1.35) +
  geom_line(aes(date, SNAIVE), color = "red", size = 1.1) + 
  geom_line(aes(date, STL), color = "orange", size = 1.1) +
  geom_line(aes(date, DYNREG), color = "blue", size = 1.1) +
  geom_line(aes(date, ARIMAX), color = "dark green", size = 1.1) +
  geom_line(aes(date, TBATS), color = "purple", size = 1.1) +
  geom_line(aes(date, STLF), color = "pink", size = 1.1) +
  theme_minimal()
```

```{r}
alt_truth <- select(alt_truth, c("date", "red", "SNAIVE", "STL", "STLF", "DYNREG", "ARIMAX", "TBATS"))
errdf <- abs(alt_truth$red - alt_truth[, 3:8])
```

```{r}
alt_truth$best <- colnames(errdf)[apply(errdf, 1, which.min)]
```

```{r}
comparison <- data.frame(orig = truth$best, longform = alt_truth$best)
comparison
```