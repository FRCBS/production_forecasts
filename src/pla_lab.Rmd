---
title: 'Forecasting Lab: Production Figures'
output: github_document
---

Tässä dokumentissa tutkitaan aikasarjaennustamista tuotannon kuukausittaisilla luvuilla. Erityisesti halutaan tietää seuraavat:

1. Kuinka hyvin ennustemallit ovat historiallisesti toimineet? Onko jompi kumpi malleista parempi?
1.1. Kuinka hyvä keskiarvoennuste on?
1.2. Kuinka hyvin vaihtelu mahtuu ennustettuihin rajoihin? Onko yksittäisiä selitettäviä poikkeamia?
1.3. Miten parametrien valinta vaikuttaa mallien suoriutumiseen (esim. ikkunan koko)?
2. Voidaanko tehdä kuukausiennuste tulevaisuuteen?
3. Onko olemassa uusia ja parempia helposti sovellettavia malleja?
4. Saisiko malleihin lisää parametreja?
4.1. Työpäivien määrä kuukaudessa
4.2. Historiallinen vuosivaihtelu
4.3. Priori yleisestä trendistä
4.4. Väestörakenne
4.4.1 Auttaako sairaanhoitopiirien tasolle meneminen?

## Create original dataset that should remain immutable throughout labbing
```{r message=FALSE}
library(forecast)
library(ggplot2)
library(gridExtra)

# Set working directory and load data
setwd("/home/esa/production_forecasts")
monthly_sales <- read.table("/home/esa/production_forecasts/data/kuukausimyynti.txt", header = T, sep = "\t")

# Separate yyyy/mmm column into months and years
monthly_sales$year <- substr(monthly_sales$kuukausi, 1, 4)
monthly_sales$month <- factor(substr(monthly_sales$kuukausi, 6, 8), levels=c("tam", "hel", "maa", "huh", "tou", "kes", "hei", "elo", "syy", "lok", "mar", "jou"))

# Create a numeric column for months
monthly_sales$month_num <- as.numeric(monthly_sales$month)

# Omit empty values
d <- na.omit(monthly_sales)
```

## Create the time series object
```{r}
ts.pla <- ts(d$Trombosyyttivalmisteet, 
             start=as.numeric(c(d$year[1], d$month_num[1])), 
             end=as.numeric(c(tail(d$year, 1), tail(d$month_num, 1))), 
             frequency=12)  # This tells the series that it is monthly data

# Month adjustment
ts.pla <- ts.pla/monthdays(ts.pla)

# Create plots for a quick overview
p1 <- autoplot(ts.pla)
p1
```


```{r}
ggseasonplot(ts.pla, year.labels = TRUE, year.labels.left = TRUE)
```

????


Trying out more advanced methods of decomposing

```{r}
# DECOMP HERE
```

EXPLANATION OF RESULTS

Let's do this again, but with filtering and see if it could improve the results
```{r}
# FILTERING PLUS DECOMP
```

EXAMINE RESULTS


## Forecasts of Jarno Tuimala now with better decomp and filtering

Jarno built his forecasts using **STL+ETS** and **ETS** models, including also a naive 6 month repetition forecast. I will not be considering the naive "forecast" here, as I'm fairly certain we want to do proper modelling. 
```{r}
# Seasonal and Trend decomposition by LOESS + ETS
# The t.window of stl() should be an odd number, but Tuimala has decided against it. Will investigate.
stl.pla <- forecast(stl(ts.pla, s.window="periodic", t.window=6), h=12)


# Exponential smoothing state space model
# ets() is an automated model selection function, so these are not the same model! Uses AICc, AIC and BIC.
ets.pla <- forecast(ets(ts.pla), h=12)


# Plot
grid.arrange(grobs=list(autoplot(stl.pla),
                        autoplot(ets.pla)),
             layout_matrix=rbind(c(1),
                                 c(2)))
```

ETS models are based on weighted averages of past observations, with *exponentially* decaying weights as the observations move further back in time. The ETS function used in Tuimala's script optimize the smoothing parameters and initial values required by minimising the sum of the squared errors (SSE). They can be simple explonential smoothing models (SES), or state space models consisting of Error, Trend and Seasonal parts. The $ets()$ function used here tries to automatically select the best model from the ets model family using information criteria measures (AIC, AICc and BIC).

The STL+ETS models use a "Seasonal and Trend decomposition by LOESS" method to extract the seasonal component of the series and feed the seasonally adjusted series to the $ets()$ function.

## Check the errors of yearly and monthly predictions. 
```{r}
yearly <- ggplot() 
forecast_errors <- c()
stl_RMSE <- c()
stl_MAPE <- c()
# Loop 
for(i in seq(from=2008, to=2018, by=1)){
  fit <- stl(window(ts.pla, start=2004, end=c(i-1, 12)), s.window="periodic", t.window=6)  # Fit based on history so far
  fcast <- forecast(fit, h=12)  # Forecast the next year
  segment <- window(ts.pla, start=i, end=c(i, 12))  # Extract that year from the history for plotting purposes
  
  # Build the plot piece by piece
  yearly <- yearly + autolayer(fcast) + autolayer(segment, colour=FALSE)
  
  # Calculate raw forecast errors
  forecast_errors <- c(forecast_errors, abs(data.frame(fcast)$Point.Forecast - segment))
  
  stl_RMSE <- c(stl_RMSE, data.frame(accuracy(fcast, segment))$RMSE)
  stl_MAPE <- c(stl_MAPE, data.frame(accuracy(fcast, segment))$MAPE)
}

yearly + ggtitle("STL+ETS forecast of platelet sales year by year") +
  scale_x_discrete(limits=c(2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018)) + xlab("Time") +
  ylab("Unit sales")
```
```{r}
autoplot(ts(forecast_errors, start=2008, end=2018, frequency=12)) + ggtitle("STL+ETS historical forecast errors for platelets") + ylab("Unit sales")
```


```{r}
yearly_ets <- ggplot() 
ets_forecast_errors <- c()
ets_RMSE <- c()
ets_MAPE <- c()
# Loop 
for(i in seq(from=2008, to=2018, by=1)){
  fit <- ets(window(ts.pla, start=2004, end=c(i-1, 12)))  # Fit based on history so far
  fcast <- forecast(fit, h=12)  # Forecast the next year
  segment <- window(ts.pla, start=i, end=c(i, 12))  # Extract that year from the history for plotting purposes
  
  # Build the plot piece by piece
  yearly_ets <- yearly_ets + autolayer(fcast) + autolayer(segment, colour=FALSE)
  
  # Calculate forecast errors
  ets_forecast_errors <- c(ets_forecast_errors, abs(data.frame(fcast)$Point.Forecast - segment))
  
  ets_RMSE <- c(ets_RMSE, data.frame(accuracy(fcast, segment))$RMSE)
  ets_MAPE <- c(ets_MAPE, data.frame(accuracy(fcast, segment))$MAPE)
}

yearly_ets + ggtitle("ETS forecast of platelet sales year by year") +
  scale_x_discrete(limits=c(2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018)) + xlab("Time") +
  ylab("Unit sales")
```
```{r}
autoplot(ts(ets_forecast_errors, start=2008, end=2018, frequency=12)) + ggtitle("ETS historical forecast errors for platelets") + ylab("Unit sales")
```

## Test out multiple regression
```{r}
# Implement multiple regression with dummy variables
```


## Playing around with a NN
```{r}
# Test this out later
fit <- nnetar(ts.pla, lambda=0)
autoplot(forecast(fit, PI=TRUE, h=12))
```